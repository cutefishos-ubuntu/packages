name: Build and sign Debian repository

on:
  push:
  pull_request:
  workflow_dispatch:

  watch:
    types: [started]

jobs:
  build-and-sign-deb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gnupg2
      
      - name: Improt GPG
        run: |
          gpg --import KEY.gpg
          
      - name: Import secret key
        run: |
          gpg --export-secret-keys "48E66A3508ECE7D9" > my-private-key.asc
          gpg --import my-private-key.asc

      - name: Export public key
        run: |
          gpg --armor --export "48E66A3508ECE7D9" > KEY.gpg

      - name: Create Debian packages
        run: |
          dpkg-scanpackages --multiversion . > Packages
          gzip -k -f Packages
          apt-ftparchive release . > Release

      - name: Sign Release with GPG
        run: |
          gpg --default-key "48E66A3508ECE7D9" -abs -o - Release > Release.gpg
          gpg --default-key "48E66A3508ECE7D9" --clearsign -o - Release > InRelease
